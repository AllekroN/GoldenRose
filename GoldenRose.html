<!DOCTYPE html>
<html>
<head>
    <title>Бальный зал "Золотая Роза"</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        #map {
            height: 100vh;
            width: 100vw;
            background: #f0f0f0;
        }
        .hidden-data { color: red; }
        .admin-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .marker-form input { margin: 5px; }
    </style>
</head>
<body>
    <div class="admin-panel" id="adminPanel" style="display: none;">
        <h3>Админ-панель</h3>
        <button onclick="showImportDialog()">Импорт из CSV</button>
        <input type="file" id="csvFile" accept=".csv" hidden>
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <script>
        // Конфигурация Firebase
        const firebaseConfig = { /* Ваши данные */ };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // Система прав доступа
        let isAdmin = false;
        let currentUserId = null;

        // Аутентификация
        auth.signInAnonymously().then(cred => {
            currentUserId = cred.user.uid;
            checkAdminRights();
        });

        async function checkAdminRights() {
            const token = await auth.currentUser.getIdTokenResult();
            isAdmin = token.claims.admin || false;
            document.getElementById('adminPanel').style.display = isAdmin ? 'block' : 'none';
        }

        // Инициализация карты
        const map = L.map('map', {
            crs: L.CRS.Simple,
            minZoom: -2,
            maxZoom: 5,
            maxBoundsViscosity: 1.0
        }).fitBounds([[0,0], [5000,5000]]);

        L.imageOverlay('https://i.imgur.com/OagxjJL.jpeg', [[0,0], [5000,5000]], {
            className: 'responsive-image'
        }).addTo(map);

        // Загрузка данных NPC (пример из CSV)
        async function loadNPCDataFromCSV(file) {
            const text = await file.text();
            const rows = text.split('\n').slice(1);
            
            rows.forEach(row => {
                const [name, type, health, armor] = row.split(';');
                database.ref('npcs').push({
                    name: name?.trim() || '???',
                    type: type?.trim() || '???',
                    health: health?.trim() || '???',
                    armor: armor?.trim() || '???'
                });
            });
        }

        // Система маркеров
        const userMarkers = {};

        function createMarker(data, id, isUserMarker = false) {
            const icon = L.icon({
                iconUrl: data.icon || 'default.png',
                iconSize: [40, 40],
                iconAnchor: [20, 40]
            });

            const marker = L.marker([data.x, data.y], {
                draggable: isUserMarker,
                icon: icon
            }).bindPopup(createPopupContent(data, id, isUserMarker));
            
            if(isUserMarker) {
                marker.on('dragend', updateMarkerPosition);
                userMarkers[id] = marker;
            }
            
            return marker.addTo(map);
        }

        function createPopupContent(data, id, isUserMarker) {
            let content = `
                <h3 class="hidden-data">${data.name || '???'}</h3>
                <p>Вид: <span class="hidden-data">${data.type || '???'}</span></p>
                <p>Здоровье: <span class="hidden-data">${data.health || '???'}</span></p>
                <p>Броня: <span class="hidden-data">${data.armor || '???'}</span></p>
            `;

            if(isAdmin) {
                content += `<button onclick="editMarker('${id}')">Редактировать</button>`;
            }

            if(isUserMarker) {
                content += `<button onclick="deleteMarker('${id}')">Удалить</button>`;
            }

            return content;
        }

        // Управление маркерами
        function deleteMarker(id) {
            database.ref(`markers/${id}`).remove();
            map.removeLayer(userMarkers[id]);
        }

        function updateMarkerPosition(e) {
            const markerId = Object.keys(userMarkers).find(key => userMarkers[key] === e.target);
            database.ref(`markers/${markerId}`).update({
                x: e.target.getLatLng().x,
                y: e.target.getLatLug().y
            });
        }

        // Админ-функции
        function showImportDialog() {
            document.getElementById('csvFile').click();
        }

        document.getElementById('csvFile').addEventListener('change', e => {
            loadNPCDataFromCSV(e.target.files[0]);
        });

        function editMarker(id) {
            // Логика редактирования через модальное окно
            const newData = prompt('Введите новые данные в формате JSON:');
            try {
                database.ref(`npcs/${id}`).update(JSON.parse(newData));
            } catch(e) {
                alert('Ошибка формата данных!');
            }
        }

        // Инициализация данных
        database.ref('markers').on('child_added', snapshot => {
            const data = snapshot.val();
            if(data.userId === currentUserId) {
                createMarker(data, snapshot.key, true);
            }
        });

        database.ref('npcs').on('child_added', snapshot => {
            if(!document.querySelector(`[data-npc-id="${snapshot.key}"]`)) {
                createMarker(snapshot.val(), snapshot.key);
            }
        });

        // Создание маркера пользователем
        map.on('click', async e => {
            if(Object.keys(userMarkers).length >= 1 && !isAdmin) {
                alert('Вы можете создать только один маркер!');
                return;
            }

            const newMarkerRef = database.ref('markers').push();
            await newMarkerRef.set({
                x: e.latlng.x,
                y: e.latlng.y,
                userId: currentUserId,
                name: 'Новый персонаж',
                type: '???',
                health: '???',
                armor: '???'
            });
        });

        // Адаптивный дизайн
        window.addEventListener('resize', () => {
            map.invalidateSize();
            L.imageOverlay('https://i.imgur.com/OagxjJL.jpeg', [[0,0], [5000,5000]]).addTo(map);
        });
    </script>
</body>
</html>
