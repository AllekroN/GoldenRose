<!DOCTYPE html>
<html>
<head>
    <title>Бальный зал "Золотая Роза"</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        #map { 
            height: 1500px; 
            width: 100%; 
            background: #f0f0f0;
        }
        .editable {
            border: 1px dashed #ccc;
            padding: 5px;
            margin: 5px 0;
        }
        button {
            margin-top: 10px;
            padding: 5px 15px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <!-- Firebase 8.x -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <!-- Leaflet -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Конфигурация Firebase (ЗАМЕНИТЕ ЭТИ ДАННЫЕ!)
        const firebaseConfig = {
  apiKey: "AIzaSyCYLz0HIs9P4xp9ILpErRmKmWr5Ljss31U",
  authDomain: "goldenroseweb.firebaseapp.com",
  databaseURL: "https://goldenroseweb-default-rtdb.firebaseio.com",
  projectId: "goldenroseweb",
  storageBucket: "goldenroseweb.firebasestorage.app",
  messagingSenderId: "355125234409",
  appId: "1:355125234409:web:5f08a1431d9525838d7e78",
  measurementId: "G-K9YD88LCNJ"
};
        
        // Инициализация Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Инициализация карты
        const imageBounds = [[0, 0], [5000, 5000]];
        const map = L.map('map', {
            crs: L.CRS.Simple,
            minZoom: -2,
            maxZoom: 5,
            inertia: false
        });

        // Фоновое изображение
        L.imageOverlay('https://i.imgur.com/OagxjJL.jpeg', imageBounds).addTo(map);
        map.fitBounds(imageBounds);

        // Загрузка маркеров
        database.ref('markers').on('value', (snapshot) => {
            console.log("Данные получены:", snapshot.val());
            
            map.eachLayer(layer => {
                if (layer instanceof L.Marker) layer.remove();
            });

            const markersData = snapshot.val();
            if (markersData) {
                Object.keys(markersData).forEach(key => {
                    createMarker(markersData[key], key);
                });
            }
        });

        // Создание маркера
        function createMarker(data, id) {
            const kingIcon = L.icon({
                iconUrl: 'https://i.imgur.com/fOvASpi.jpeg',
                iconSize: [40, 40],
                iconAnchor: [20, 40]
            });

            const marker = L.marker([data.x, data.y], {
                draggable: true,
                icon: kingIcon
            }).bindPopup(`
                <h3 contenteditable="true" class="editable">${data.title || 'Новый персонаж'}</h3>
                <div contenteditable="true" class="editable">${data.content || 'Описание...'}</div>
                <button onclick="saveChanges('${id}')">Сохранить</button>
            `).addTo(map);

            // Обработка перемещения
            marker.on('dragend', (e) => {
                const newPos = e.target.getLatLng();
                console.log("Новая позиция:", newPos);
                
                database.ref(`markers/${id}`).update({
                    x: newPos.x,
                    y: newPos.y
                })
                .then(() => console.log("Позиция сохранена"))
                .catch(error => console.error("Ошибка сохранения позиции:", error));
            });
        }

        // Сохранение текста
        window.saveChanges = function(id) {
            const popupContent = document.querySelector('.leaflet-popup-content');
            const title = popupContent.querySelector('h3').innerText;
            const content = popupContent.querySelector('div').innerText;
            
            console.log("Сохранение текста:", {id, title, content});
            
            database.ref(`markers/${id}`).update({ 
                title: title,
                content: content 
            })
            .then(() => console.log("Текст успешно сохранен"))
            .catch(error => console.error("Ошибка сохранения текста:", error));
        };

        // Создание нового маркера
        map.on('click', (e) => {
            console.log("Создание маркера в:", e.latlng);
            
            const newMarkerRef = database.ref('markers').push();
            newMarkerRef.set({
                x: e.latlng.x,
                y: e.latlng.y,
                title: 'Новый персонаж',
                content: 'Описание...'
            })
            .then(() => console.log("Маркер создан"))
            .catch(error => console.error("Ошибка создания маркера:", error));
        });
    </script>
</body>
</html>
