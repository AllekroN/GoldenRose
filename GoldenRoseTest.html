<!DOCTYPE html>
<html>
<head>
    <title>Бальный зал "Золотая Роза"</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        #map { 
            height: 1500px; 
            width: 100%; 
            background: #f0f0f0;
        }
        .editable {
            border: 1px dashed #ccc;
            padding: 5px;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <!-- Подключение Firebase 8.x -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <!-- Leaflet -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Конфигурация Firebase (ЗАМЕНИТЕ НА СВОЮ!)
        const firebaseConfig = {
            apiKey: "AIzaSyBx...",
            authDomain: "ваш-проект.firebaseapp.com",
            databaseURL: "https://ваш-проект.firebaseio.com",
            projectId: "ваш-проект",
            storageBucket: "ваш-проект.appspot.com",
            messagingSenderId: "123456789"
        };
        
        // Инициализация Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Инициализация карты
        const imageBounds = [[0, 0], [5000, 5000]];
        const map = L.map('map', {
            crs: L.CRS.Simple,
            minZoom: -2,
            maxZoom: 5
        });

        // Загрузка фонового изображения (проверьте ссылку!)
        L.imageOverlay('https://i.imgur.com/OagxjJL.jpeg', imageBounds).addTo(map);
        map.fitBounds(imageBounds);

        // Загрузка маркеров из Firebase
        database.ref('markers').on('value', (snapshot) => {
            const markersData = snapshot.val();
            
            // Очистка старых маркеров
            map.eachLayer(layer => {
                if (layer instanceof L.Marker) layer.remove();
            });

            // Создание новых маркеров
            if (markersData) {
                Object.keys(markersData).forEach(key => {
                    createMarker(markersData[key], key);
                });
            }
        });

        // Функция создания маркера
        function createMarker(data, id) {
            const kingIcon = L.icon({
                iconUrl: 'https://i.imgur.com/fOvASpi.jpeg',
                iconSize: [40, 40],
                iconAnchor: [20, 40]
            });

            const marker = L.marker([data.x, data.y], {
                draggable: true,
                icon: kingIcon
            }).bindPopup(`
                <h3 contenteditable="true" class="editable">${data.title || 'Новый персонаж'}</h3>
                <div contenteditable="true" class="editable">${data.content || 'Описание...'}</div>
                <button onclick="saveChanges('${id}')">Сохранить</button>
            `).addTo(map);

            // Обновление позиции при перемещении
            marker.on('dragend', (e) => {
                const newPos = e.target.getLatLng();
                database.ref(`markers/${id}`).update({
                    x: newPos.x,
                    y: newPos.y
                });
            });
        }

        // Сохранение изменений текста
        window.saveChanges = function(id) {
            const popupContent = document.querySelector('.leaflet-popup-content');
            const title = popupContent.querySelector('h3').innerText;
            const content = popupContent.querySelector('div').innerText;
            
            database.ref(`markers/${id}`).update({ 
                title: title,
                content: content 
            });
        };

        // Добавление нового маркера по клику
        map.on('click', (e) => {
            const newMarkerRef = database.ref('markers').push();
            newMarkerRef.set({
                x: e.latlng.x,
                y: e.latlng.y,
                title: 'Новый персонаж',
                content: 'Описание...'
            });
        });
    </script>
</body>
</html>
